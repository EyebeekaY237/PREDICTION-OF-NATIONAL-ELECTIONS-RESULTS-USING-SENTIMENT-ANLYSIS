{% extends "base.html" %}
{% load static %}

{% block extra_css %} 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
 
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7f9;
            color: #333;
            line-height: 1.6;
        }
        
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        h1 {
            text-align: center;
            color: #1a6e1a;
            margin-bottom: 0.5rem;
            font-size: 2.5rem;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }
        
        /* Candidate Cards */
        .candidates {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .candidate {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            width: 300px;
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .candidate:hover {
            transform: translateY(-5px);
        }
        
        .candidate img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 1rem;
            border: 4px solid #f0f0f0;
        }
        
        .candidate h3 {
            color: #1a6e1a;
            margin-bottom: 0.5rem;
        }
        
        .party {
            font-weight: bold;
            color: #555;
            margin-bottom: 0.3rem;
        }
        
        .twitter-handle {
            color: #1da1f2;
            margin-bottom: 1rem;
        }
        
        /* Progress Bars */
        .progress-container {
            margin-top: 1rem;
        }
        
        .progress-bar {
            height: 25px;
            background-color: #f0f0f0;
            border-radius: 20px;
            margin-bottom: 0.5rem;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            border-radius: 20px;
            transition: width 1s ease-in-out;
        }
        
        .vote-count {
            font-weight: bold;
            margin-bottom: 0.3rem;
        }
        
        .sentiment {
            font-size: 0.9rem;
            color: #666;
        }
        
        .ml-sentiment {
            font-size: 0.8rem;
            color: #888;
            font-style: italic;
        }
        
        /* Button and Loading */
        .checker-btn {
            display: block;
            margin: 2rem auto;
            padding: 12px 24px;
            background-color: #1a6e1a;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .checker-btn:hover {
            background-color: #145a14;
        }
        
        .checker-btn.loading {
            background-color: #888;
            cursor: not-allowed;
        }
        
        .loading-indicator {
            text-align: center;
            padding: 1rem;
            display: none;
            color: #666;
        }
        
        .disclaimer {
            margin-top: 2rem;
            font-size: 0.9rem;
            color: #666;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            padding: 1rem;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        
        .model-status {
            text-align: center;
            padding: 0.5rem;
            background-color: #e8f5e8;
            border-radius: 5px;
            margin: 1rem auto;
            max-width: 400px;
            font-size: 0.9rem;
        }
        
        /* Analysis Container Styles */
        .analysis-container {
            margin-top: 3rem;
            background-color: white;
            padding: 2rem;
            border-radius: 10px;  
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .analysis-tabs {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 2rem;
        }

        .analysis-tab {
            background-color: #f0f0f0;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .analysis-tab:hover {
            background-color: #e0e0e0;
        }

        .analysis-tab.active {
            background-color: #1a6e1a;
            color: white;
        }

        .analysis-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 2rem;
        }

        .analysis-chart {
            flex: 1;
            min-width: 300px;
            background-color: #f9f9f9;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .analysis-stats {
            background-color: #f9f9f9;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .analysis-stats p {
            margin-bottom: 0.8rem;
        }

        .candidate-analysis {
            display: none;
        }

        .candidate-analysis:first-child {
            display: block;
        }

        /* Sentiment Comparison */
        .sentiment-comparison {
            margin-top: 2rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #1a6e1a;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .candidates {
                flex-direction: column;
                align-items: center;
            }
            
            .candidate {
                width: 100%;
                max-width: 350px;
            }
            
            .analysis-row {
                flex-direction: column;
            }
            
            .analysis-tabs {
                flex-wrap: wrap;
            }
        }
    </style>
 
{% endblock %}

{% block content %}
    <div class="main-content">
        <h1>Nigeria Presidential Election Prediction</h1>
        <p class="subtitle">Real-time sentiment analysis based on Twitter (X) data</p>
        
        <div class="model-status" id="modelStatus">
            Analysis Type: {{ model_status|default:"Rule-Based Analysis" }}
        </div>
        
        <div class="candidates">
            <div class="candidate">
                <img src="https://www.wathi.org/wp-content/uploads/2023/02/Bola-Ahmed-Tinubu.jpg" alt="Bola Tinubu">
                <h3>Bola Tinubu</h3>
                <p class="party">Party: APC</p>
                <p class="twitter-handle">@officialABAT</p>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress" id="progress1" style="background-color: #1a6e1a; width: 40%;"></div>
                    </div>
                    <div class="vote-count" id="votes1">8,000,000 votes (40.0%)</div>
                    <div class="sentiment" id="sentiment1">Sentiment: 0.50 (Positive)</div>
                    <div class="ml-sentiment" id="mlSentiment1">ML Analysis: 0.72 (Very Positive)</div>
                </div>
            </div>
            
            <div class="candidate">
                <img src="https://th.bing.com/th/id/OIP.yppVgq-WyNXtLT4q0aXFcwAAAA?rs=1&pid=ImgDetMain" alt="Atiku Abubakar">
                <h3>Atiku Abubakar</h3>
                <p class="party">Party: PDP</p>
                <p class="twitter-handle">@atiku</p>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress" id="progress2" style="background-color: #d62b2b; width: 35%;"></div>
                    </div>
                    <div class="vote-count" id="votes2">7,000,000 votes (35.0%)</div>
                    <div class="sentiment" id="sentiment2">Sentiment: 0.40 (Positive)</div>
                    <div class="ml-sentiment" id="mlSentiment2">ML Analysis: 0.52 (Positive)</div>
                </div>
            </div>
            
            <div class="candidate">
                <img src="https://th.bing.com/th/id/OIP.nQNXC6hoOjrWv8oYMWSACgHaEU?rs=1&pid=ImgDetMain" alt="Peter Obi">
                <h3>Peter Obi</h3>
                <p class="party">Party: LP</p>
                <p class="twitter-handle">@PeterObi</p>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress" id="progress3" style="background-color: #0a5c0a; width: 25%;"></div>
                    </div>
                    <div class="vote-count" id="votes3">5,000,000 votes (25.0%)</div>
                    <div class="sentiment" id="sentiment3">Sentiment: 0.70 (Positive)</div>
                    <div class="ml-sentiment" id="mlSentiment3">ML Analysis: 0.91 (Very Positive)</div>
                </div>
            </div>
        </div>
      
        <div class="loading-indicator" id="loadingIndicator">
            <p>Analyzing recent Twitter sentiment data. This may take a moment...</p>
            <p>Using advanced ML sentiment analysis...</p>
        </div>
        
        <button class="checker-btn" id="checkerBtn" onclick="checkResults()">Check Twitter Sentiment</button>
        
         
        <div class="disclaimer">
            <p><strong>Disclaimer:</strong> This prediction is based on sentiment analysis of recent Twitter (X) data and is not an official poll. Results are simulated for demonstration purposes only.</p>
            <p><strong>Analysis Method:</strong> <span id="analysisMethod">Rule-Based Analysis</span></p>
        </div>

        <!-- Detailed Sentiment Analysis Section -->
        <div class="analysis-container">
            <h2 style="text-align: center; color: #1a6e1a;">Detailed Sentiment Analysis</h2>
            
            <div class="analysis-tabs">
                <button class="analysis-tab active" onclick="showAnalysis('tinubu')">Tinubu</button>
                <button class="analysis-tab" onclick="showAnalysis('atiku')">Atiku</button>
                <button class="analysis-tab" onclick="showAnalysis('obi')">Obi</button>
            </div>
            
            <div id="tinubu-analysis" class="candidate-analysis">
                <div class="analysis-row">
                    <div class="analysis-chart">
                        <h3>Sentiment Distribution</h3>
                        <canvas id="tinubu-sentiment-chart" height="90"></canvas>
                    </div>
                    <div class="analysis-chart">
                        <h3>Trend Over Time</h3>
                        <canvas id="tinubu-trend-chart" height="90"></canvas>
                    </div>
                </div>
                <div class="analysis-stats">
                    <h3>Key Metrics</h3>
                    <p><strong>Total Tweets Analyzed:</strong> <span id="tinubu-tweet-count">125</span></p>
                    <p><strong>Top Keywords:</strong> <span id="tinubu-keywords">economy, development, APC, manifesto</span></p>
                    <p><strong>Average Likes:</strong> <span id="tinubu-avg-likes">245</span></p>
                    <p><strong>Average Retweets:</strong> <span id="tinubu-avg-retweets">78</span></p>
                    <p><strong>Estimated Reach:</strong> <span id="tinubu-reach">2,450,000</span> users</p>
                    <p><strong>ML Sentiment Score:</strong> <span id="tinubu-ml-score">0.72</span></p>
                </div>
            </div>
            
            <!-- Atiku Analysis -->
            <div id="atiku-analysis" class="candidate-analysis" style="display: none;">
                <div class="analysis-row">
                    <div class="analysis-chart">
                        <h3>Sentiment Distribution</h3>
                        <canvas id="atiku-sentiment-chart" height="90"></canvas>
                    </div>
                    <div class="analysis-chart">
                        <h3>Trend Over Time</h3>
                        <canvas id="atiku-trend-chart" height="90"></canvas>
                    </div>
                </div>
                <div class="analysis-stats">
                    <h3>Key Metrics</h3>
                    <p><strong>Total Tweets Analyzed:</strong> <span id="atiku-tweet-count">98</span></p>
                    <p><strong>Top Keywords:</strong> <span id="atiku-keywords">experience, unity, PDP, governance</span></p>
                    <p><strong>Average Likes:</strong> <span id="atiku-avg-likes">187</span></p>
                    <p><strong>Average Retweets:</strong> <span id="atiku-avg-retweets">62</span></p>
                    <p><strong>Estimated Reach:</strong> <span id="atiku-reach">1,872,000</span> users</p>
                    <p><strong>ML Sentiment Score:</strong> <span id="atiku-ml-score">0.52</span></p>
                </div>
            </div>
            
            <!-- Obi Analysis -->
            <div id="obi-analysis" class="candidate-analysis" style="display: none;">
                <div class="analysis-row">
                    <div class="analysis-chart">
                        <h3>Sentiment Distribution</h3>
                        <canvas id="obi-sentiment-chart" height="90"></canvas>
                    </div>
                    <div class="analysis-chart">
                        <h3>Trend Over Time</h3>
                        <canvas id="obi-trend-chart" height="90"></canvas>
                    </div>
                </div>
                <div class="analysis-stats">
                    <h3>Key Metrics</h3>
                    <p><strong>Total Tweets Analyzed:</strong> <span id="obi-tweet-count">156</span></p>
                    <p><strong>Top Keywords:</strong> <span id="obi-keywords">youth, change, LP, accountability</span></p>
                    <p><strong>Average Likes:</strong> <span id="obi-avg-likes">321</span></p>
                    <p><strong>Average Retweets:</strong> <span id="obi-avg-retweets">134</span></p>
                    <p><strong>Estimated Reach:</strong> <span id="obi-reach">3,210,000</span> users</p>
                    <p><strong>ML Sentiment Score:</strong> <span id="obi-ml-score">0.91</span></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Store chart instances to destroy on update
        let sentimentCharts = {};
        let trendCharts = {};

        // Function to create a bar chart for sentiment distribution
        function createSentimentChart(chartId, positive, neutral, negative, color) {
            const ctx = document.getElementById(chartId).getContext('2d');
            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Positive', 'Neutral', 'Negative'],
                    datasets: [{
                        label: 'Number of Mentions',
                        data: [positive, neutral, negative],
                        backgroundColor: [
                            'rgba(75, 192, 75, 0.6)',
                            'rgba(200, 200, 50, 0.6)',
                            'rgba(220, 50, 50, 0.6)'
                        ],
                        borderColor: 'rgba(0,0,0,0.1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Count'
                            }
                        }
                    }
                }
            });
        }

        // Function to create a line chart for trend over time
        function createTrendChart(chartId, labels, data, color) {
            const ctx = document.getElementById(chartId).getContext('2d');
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Sentiment Score',
                        data: data,
                        borderColor: color,
                        backgroundColor: `${color}33`,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        y: {
                            min: -1,
                            max: 1,
                            title: {
                                display: true,
                                text: 'Sentiment Score'
                            }
                        }
                    }
                }
            });
        }

        // Function to update UI with data from Django
        function updateCandidateUI(candidateId, data) {
            const index = candidateId === 'tinubu' ? 1 : candidateId === 'atiku' ? 2 : 3;
            document.getElementById(`progress${index}`).style.width = `${data.percentage}%`;
            document.getElementById(`votes${index}`).textContent = 
                `${formatNumber(data.votes)} votes (${data.percentage.toFixed(1)}%)`;
            document.getElementById(`sentiment${index}`).textContent = 
                `Sentiment: ${data.sentiment.toFixed(2)} (${getSentimentLabel(data.sentiment)})`;
            
            // Update ML sentiment if available
            if (data.ml_sentiment !== undefined) {
                document.getElementById(`mlSentiment${index}`).textContent = 
                    `ML Analysis: ${data.ml_sentiment.toFixed(2)} (${getSentimentLabel(data.ml_sentiment)})`;
                document.getElementById(`mlSentiment${index}`).style.display = 'block';
            }
        }

        // Function to fetch data from Django backend
        async function checkResults() {
            const btn = document.getElementById('checkerBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            
            // Show loading state
            btn.classList.add('loading');
            btn.disabled = true;
            loadingIndicator.style.display = 'block';
            
            try {
                // Fetch data from Django backend
                const response = await fetch('/get-results/');
                const data = await response.json();
                
                // Update UI with the received data
                updateCandidateUI('tinubu', data.tinubu);
                updateCandidateUI('atiku', data.atiku);
                updateCandidateUI('obi', data.obi);
                
                // Update analysis method in disclaimer
                document.getElementById('analysisMethod').textContent = 
                    data.model_info?.analysis_type || 'Rule-Based Analysis';
                
                // Update model status
                document.getElementById('modelStatus').textContent = 
                    `Analysis Type: ${data.model_info?.analysis_type || 'Rule-Based Analysis'}`;
                
                // Update detailed analysis if available
                if (data.detailed) {
                    updateDetailedAnalysis(data.detailed);
                }
                
            } catch (error) {
                console.error('Error fetching results:', error);
                alert('Error analyzing Twitter data. Please try again later.');
            } finally {
                // Hide loading state
                btn.classList.remove('loading');
                btn.disabled = false;
                loadingIndicator.style.display = 'none';
            }
        }

        // Function to analyze single tweet
        async function analyzeSingleTweet(event) {
            event.preventDefault();
            
            const tweetText = document.getElementById('tweetText').value.trim();
            const resultDiv = document.getElementById('tweetResult');
            
            if (!tweetText) {
                alert('Please enter tweet text to analyze');
                return;
            }
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p>Analyzing sentiment...</p>';
            
            try {
                const response = await fetch('/analyze-tweet/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: new URLSearchParams({
                        'text': tweetText
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    resultDiv.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
                } else {
                    const sentimentLabel = getSentimentLabel(data.sentiment_score);
                    resultDiv.innerHTML = `
                        <p><strong>Text:</strong> "${tweetText.substring(0, 100)}${tweetText.length > 100 ? '...' : ''}"</p>
                        <p><strong>Sentiment Score:</strong> ${data.sentiment_score.toFixed(4)}</p>
                        <p><strong>Sentiment:</strong> ${sentimentLabel}</p>
                        <p><strong>Analysis Type:</strong> ${data.analysis_type}</p>
                    `;
                }
                
            } catch (error) {
                console.error('Error analyzing tweet:', error);
                resultDiv.innerHTML = '<p style="color: red;">Error analyzing tweet. Please try again.</p>';
            }
        }
        
        // Function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Function to update detailed analysis section with charts
        function updateDetailedAnalysis(detailedData) {
            // Destroy old charts to avoid memory leaks
            Object.values(sentimentCharts).forEach(chart => chart.destroy());
            Object.values(trendCharts).forEach(chart => chart.destroy());

            for (const [candidate, stats] of Object.entries(detailedData)) {
                const prefix = `${candidate}`;

                // Update metrics
                document.getElementById(`${prefix}-tweet-count`).textContent = stats.tweet_count || '0';
                document.getElementById(`${prefix}-keywords`).textContent = 
                    stats.top_keywords ? stats.top_keywords.join(', ') : '-';

                if (stats.engagement) {
                    document.getElementById(`${prefix}-avg-likes`).textContent = stats.engagement.avg_likes;
                    document.getElementById(`${prefix}-avg-retweets`).textContent = stats.engagement.avg_retweets;
                    document.getElementById(`${prefix}-reach`).textContent = formatNumber(stats.engagement.total_reach);
                }

                // Update ML sentiment score if available
                if (stats.sentiment_analysis && stats.sentiment_analysis.ml_avg !== undefined) {
                    document.getElementById(`${prefix}-ml-score`).textContent = 
                        stats.sentiment_analysis.ml_avg.toFixed(2);
                }

                // Mock sentiment distribution (can be replaced with real breakdown)
                const total = stats.tweet_count;
                const positive = Math.round(total * 0.7);
                const negative = Math.round(total * 0.1);
                const neutral = total - positive - negative;

                // Create sentiment chart
                sentimentCharts[candidate] = createSentimentChart(
                    `${prefix}-sentiment-chart`,
                    positive, neutral, negative,
                    candidate === 'tinubu' ? '#1a6e1a' :
                    candidate === 'atiku' ? '#d62b2b' : '#0a5c0a'
                );

                // Mock trend data (last 7 days)
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                const randomWalk = () => {
                    let value = 0.5;
                    return days.map(() => {
                        value += (Math.random() - 0.5) * 0.3;
                        return Math.max(-1, Math.min(1, value));
                    });
                };

                trendCharts[candidate] = createTrendChart(
                    `${prefix}-trend-chart`,
                    days,
                    randomWalk(),
                    candidate === 'tinubu' ? '#1a6e1a' :
                    candidate === 'atiku' ? '#d62b2b' : '#0a5c0a'
                );
            }
        }
        
        // Show analysis tab
        function showAnalysis(candidate) {
            // Hide all analysis sections
            document.querySelectorAll('.candidate-analysis').forEach(el => {
                el.style.display = 'none';
            });
            
            // Show selected candidate's analysis
            document.getElementById(`${candidate}-analysis`).style.display = 'block';
            
            // Update active tab
            document.querySelectorAll('.analysis-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        // Format large numbers with commas
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // Get sentiment label (positive/neutral/negative)
        function getSentimentLabel(score) {
            if (score > 0.6) return 'Very Positive';
            if (score > 0.3) return 'Positive';
            if (score > 0.1) return 'Slightly Positive';
            if (score > -0.1) return 'Neutral';
            if (score > -0.3) return 'Slightly Negative';
            if (score > -0.6) return 'Negative';
            return 'Very Negative';
        }
        
        // Initialize with data from Django template
        document.addEventListener('DOMContentLoaded', function() {
            const initialData = {
                tinubu: { votes: 8000000, percentage: 40.0, sentiment: 0.50, ml_sentiment: 0.72 },
                atiku: { votes: 7000000, percentage: 35.0, sentiment: 0.40, ml_sentiment: 0.52 },
                obi: { votes: 5000000, percentage: 25.0, sentiment: 0.70, ml_sentiment: 0.91 }
            };
            
            updateCandidateUI('tinubu', initialData.tinubu);
            updateCandidateUI('atiku', initialData.atiku);
            updateCandidateUI('obi', initialData.obi);
            
            // Show ML sentiment scores
            document.querySelectorAll('.ml-sentiment').forEach(el => {
                el.style.display = 'block';
            });
        });
    </script>
 
{% endblock %}